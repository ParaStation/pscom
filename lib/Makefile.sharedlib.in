#							-*- Makefile -*-
# ParaStation
#
# Copyright (C) 2002-2004 ParTec AG, Karlsruhe
# Copyright (C) 2005 ParTec Cluster Competence Center GmbH, Munich
#
# This file may be distributed under the terms of the Q Public License
# as defined in the file LICENSE.QPL included in the packaging of this
# file.
#
# Author:	Jens Hauke <hauke@par-tec.com>
#

CFLAGS += -O3 @CFLAG_WALL@ @CFLAG_G@ @CFLAG_COMPAT@
CPPFLAGS += $(LIBINC) $(LIBDEF) @CPPFLAG_MMD@

ifeq (@target_cpu@, powerpc64)
ifeq (@target_vendor@, redhat)
LDFLAGS +=  -m elf64ppc
endif
endif

TARGET_OS := @target_os@

########################################

# LIBNAME = psport
# LIBOBJS = psport.o
# LIBVPATH = @srcdir@
# LIBINC = -I@top_srcdir@/include
# LIBDSTDIR = ../..
_LIBDEPS := $(LIBOBJS:.o=@DEPEXTENSION@)
_LIBDESTNAME := $(LIBDSTDIR)/lib$(LIBNAME).so
########################################
RANLIB := @RANLIB@

VPATH += $(LIBVPATH)

ifneq ("$(TARGET_OS)","osf5.1")

all: $(_LIBDESTNAME)

ifneq ($(LIBSONAME),)
_LIBSONAME= -Wl,-soname,$(LIBSONAME)
endif

# Dont use stack protector! (hidden symbol __stack_chk_fail_local ...)
CFLAGS:=$(subst -fstack-protector,,$(CFLAGS))

COMPILE.c-shared = $(CC) $(CFLAGS) $(CPPFLAGS) $(TARGET_ARCH) -fPIC -DPIC -c
%.o: %.c
	$(COMPILE.c-shared) $(OUTPUT_OPTION) $<

#Link with gcc (not LD)(hidden symbol `atexit' in libc_nonshared.a is referenced by DSO)
$(_LIBDESTNAME): $(LIBOBJS)
	$(CC) -shared $(LDFLAGS) $(LIBOBJS) -o $@ $(LIBEXTERNAL_SHARED) $(_LIBSONAME)

clean:
	$(RM) $(LIBOBJS)

distclean:
	$(RM) $(LIBOBJS) $(_LIBDEPS) $(_LIBDESTNAME)


-include $(_LIBDEPS)

else
# No shared libs for tru64. Maybe in the future?
all:
	@echo "Warning: No shared lib support fur tru64!"
clean:
endif
